部署环境，这里将各个服务，分开部署

| 主机 | IP | 端口 |
| --- | --- | --- |
| Redis | 192.168.39.132 | 6379 |
| Zookeeper | 192.168.39.133 | 2181 |
| Mpush |  | 3000 |
| Alloc |  | 9999 |

服务器版本为Centos7，最小化安装。

note：

1）最小化安装完，可能默认网卡没有开机自动启动，可以编辑网卡文件，将ONBOOT设置为yes

> \[root@localhost ~\]\# vim \/etc\/sysconfig\/network-scripts\/ifcfg-eno16777736
> 
> TYPE=Ethernet
> 
> BOOTPROTO=dhcp
> 
> DEFROUTE=yes
> 
> PEERDNS=yes
> 
> PEERROUTES=yes
> 
> IPV4\_FAILURE\_FATAL=no
> 
> IPV6INIT=yes
> 
> IPV6\_AUTOCONF=yes
> 
> IPV6\_DEFROUTE=yes
> 
> IPV6\_PEERDNS=yes
> 
> IPV6\_PEERROUTES=yes
> 
> IPV6\_FAILURE\_FATAL=no
> 
> NAME=eno16777736
> 
> UUID=a4ad8a0c-ff3a-4a49-87fe-639f0053873f
> 
> DEVICE=eno16777736
> 
> **ONBOOT=yes**

2）安装系统基本依赖包，用于编译安装软件

> \[root@localhost ~\]\# yum install net-tools vim wget make gcc g++ gc++ -y

3）关闭防火墙和SELinux，防止系统干扰导致部署不成功

> \[root@localhost ~\]\# setenforce 0
> 
> \[root@localhost ~\]\# iptables -F
> 
> \[root@localhost ~\]\# iptables -X

# 一、编译安装Redis

[官网](http://redis.io/)下载Redis包，这里下载的是3.2.3版本

1、编译安装Redis

> \[root@localhost ~\]\# mkdir \/app
> 
> \[root@localhost ~\]\# cd \/app
> 
> \[root@localhost ~\]\# wget http:\/\/download.redis.io\/releases\/redis-3.2.3.tar.gz
> 
> 解压
> 
> \[root@localhost ~\]\# tar xf redis-3.2.3.tar.gz
> 
> \[root@localhost ~\]\# cd redis-3.2.3
> 
> 编译Redis
> 
> \[root@localhost redis-3.2.3\]\# make
> 
> 安装Redis
> 
> \[root@localhost redis-3.2.3\]\# make install
> 
> cd src && make install
> 
> make\[1\]: Entering directory \`\/app\/redis-3.2.3\/src'
> 
> Hint: It's a good idea to run 'make test' ;\)
> 
> INSTALL install
> 
> INSTALL install
> 
> INSTALL install
> 
> INSTALL install
> 
> INSTALL install
> 
> make\[1\]: Leaving directory \`\/app\/redis-3.2.3\/src'

2、提供配置文件和基础数据目录（我这里将Redis执行文件复制出来了）

> \[root@localhost redis-3.2.3\]\# mkdir -pv \/app\/redis\/{bin,conf,log,db}
> 
> mkdir: created directory ‘\/app\/redis’
> 
> mkdir: created directory ‘\/app\/redis\/bin’
> 
> mkdir: created directory ‘\/app\/redis\/conf’
> 
> mkdir: created directory ‘\/app\/redis\/log’
> 
> mkdir: created directory ‘\/app\/redis\/db’
> 
> \[root@localhost redis-3.2.3\]\# cd src
> 
> \[root@localhost src\]\# mv redis-benchmark redis-check-aof redis-check-rdb redis-cli redis-sentinel redis-server \/app\/redis\/bin\/
> 
> \[root@localhost src\]\# cd \/app\/redis
> 
> 提供启动配置文件
> 
> \[root@localhost redis\]\# vim conf\/redis.conf
> 
> daemonize yes
> 
> pidfile \/var\/run\/redis.pid
> 
> port 6379
> 
> timeout 0
> 
> tcp-keepalive 0
> 
> databases 16
> 
> save 900 1
> 
> save 300 10
> 
> save 60 10000
> 
> stop-writes-on-bgsave-error yes
> 
> rdbcompression yes
> 
> rdbchecksum yes
> 
> dir \/app\/redis\/db
> 
> dbfilename dump-6379.rdb
> 
> loglevel notice
> 
> logfile \/app\/redis\/log\/redis.log
> 
> slave-serve-stale-data yes
> 
> slave-read-only yes
> 
> repl-disable-tcp-nodelay no
> 
> slave-priority 100
> 
> appendonly no
> 
> appendfsync everysec
> 
> no-appendfsync-on-rewrite no
> 
> auto-aof-rewrite-percentage 100
> 
> auto-aof-rewrite-min-size 64mb
> 
> lua-time-limit 5000
> 
> slowlog-log-slower-than 10000
> 
> slowlog-max-len 128
> 
> hash-max-ziplist-entries 512
> 
> hash-max-ziplist-value 64
> 
> list-max-ziplist-entries 512
> 
> list-max-ziplist-value 64
> 
> set-max-intset-entries 512
> 
> zset-max-ziplist-entries 128
> 
> zset-max-ziplist-value 64
> 
> activerehashing yes
> 
> client-output-buffer-limit normal 0 0 0
> 
> client-output-buffer-limit slave 256mb 64mb 60
> 
> client-output-buffer-limit pubsub 32mb 8mb 60
> 
> hz 10
> 
> aof-rewrite-incremental-fsync yes
> 
> 启动Redis服务
> 
> \[root@localhost redis\]\# \/app\/redis\/bin\/redis-server \/app\/redis\/conf\/redis.conf
> 
> 查看是否启动Redis服务，并监听指定端口
> 
> \[root@localhost redis\]\# netstat -tplan \| grep redis
> 
> tcp 0 0 0.0.0.0:6379 0.0.0.0:\* LISTEN 6309\/redis-server \*
> 
> tcp6 0 0 :::6379 :::\* LISTEN 6309\/redis-server \*
> 
> \[root@localhost redis\]\# ps aux \| grep redis
> 
> root 6309 0.1 0.7 136916 7572 ? Ssl 12:03 0:00 \/app\/redis\/bin\/redis-server \*:6379
> 
> root 6335 0.0 0.0 112644 980 pts\/0 S+ 12:08 0:00 grep --color=auto redis
> 
> 使用Redis客户端测试
> 
> \[root@localhost redis\]\# \/app\/redis\/bin\/redis-cli
> 
> 127.0.0.1:6379&gt; set mpush mpush0.0.3
> 
> OK
> 
> 127.0.0.1:6379&gt; get mpush
> 
> "mpush0.0.3"
> 
> 127.0.0.1:6379&gt;
> 
> 查看Redis日志
> 
> \[root@localhost redis\]\# tailf \/app\/redis\/log\/redis.log

# 二、安装Zookeeper

> \[root@localhost app\]\# ll
> 
> -rw-------. 1 root root 181352138 Sep 6 22:54 jdk-8u101-linux-x64.tar.gz
> 
> -rw-------. 1 root root 22724574 Sep 6 23:02 zookeeper-3.4.9.tar.gz

1、安装JDK并设置环境变量

> \[root@localhost app\]\# tar xf jdk-8u101-linux-x64.tar.gz
> 
> \[root@localhost app\]\# ln -s jdk1.8.0\_101 jdk
> 
> \[root@localhost app\]\# vim \/etc\/profile.d\/java.sh
> 
> JAVA\_HOME=\/app\/jdk
> 
> PATH=$JAVA\_HOME\/bin:$PATH
> 
> CLASSPATH=.:$JAVA\_HOME\/lib\/dt.jar:$JAVA\_HOME\/lib\/tools.jar
> 
> export JAVA\_HOME PATH CLASSPATH
> 
> \[root@localhost app\]\# chmod +x \/etc\/profile.d\/java.sh
> 
> \[root@localhost app\]\# java -version
> 
> java version "1.8.0\_101"
> 
> Java\(TM\) SE Runtime Environment \(build 1.8.0\_101-b13\)
> 
> Java HotSpot\(TM\) 64-Bit Server VM \(build 25.101-b13, mixed mode\)

2、安装Zookeeper

> \[root@localhost app\]\# tar xf zookeeper-3.4.9.tar.gz
> 
> \[root@localhost app\]\# ln -s zookeeper-3.4.9 zookeeper
> 
> \[root@localhost app\]\# cd zookeeper
> 
> \[root@localhost zookeeper\]\# mkdir data
> 
> 提供配置文件
> 
> \[root@localhost zookeeper\]\# cp conf\/zoo\_sample.cfg conf\/zoo.cfg
> 
> \[root@localhost zookeeper\]\# vim conf\/zoo.cfg
> 
> tickTime=2000
> 
> initLimit=10
> 
> syncLimit=5
> 
> **dataDir=\/app\/zookeeper\/data**
> 
> clientPort=2181

启动Zookeeper服务

> \[root@localhost zookeeper\]\# bin\/zkServer.sh start
> 
> ZooKeeper JMX enabled by default
> 
> Using config: \/app\/zookeeper\/bin\/..\/conf\/zoo.cfg
> 
> Starting zookeeper ... STARTED

查看端口监听

> \[root@localhost zookeeper\]\# netstat -tplan \| grep 2181
> 
> tcp6 0 0 :::2181 :::\* LISTEN 3180\/java

使用Zookeeper的客户端测试

> \[root@localhost zookeeper\]\# bin\/zkCli.sh
> 
> Connecting to localhost:2181
> 
> ......................................................
> 
> ......................................................
> 
> WATCHER::
> 
> WatchedEvent state:SyncConnected type:None path:null
> 
> \[zk: localhost:2181\(CONNECTED\) 0\]
> 
> \[zk: localhost:2181\(CONNECTED\) 2\] create mpush
> 
> \[zk: localhost:2181\(CONNECTED\) 4\] ls \/
> 
> \[zookeeper\]

三、安装MPush

使用群文件提供的mpush-release-0.0.3.tar.gz，或者下载https:\/\/github.com\/mpusher\/mpush代码，自己打包，都可以

> \[root@localhost app\]\# ll
> 
> total 186716
> 
> -rw-------. 1 root root 181352138 Sep 6 22:54 jdk-8u101-linux-x64.tar.gz
> 
> -rw-------. 1 root root 9840899 Sep 7 02:28 mpush-release-0.0.3.tar.gz

1、安装JDK并设置环境变量

> \[root@localhost app\]\# tar xf jdk-8u101-linux-x64.tar.gz
> 
> \[root@localhost app\]\# ln -s jdk1.8.0\_101 jdk
> 
> \[root@localhost app\]\# vim \/etc\/profile.d\/java.sh
> 
> \[root@localhost app\]\# chmod +x \/etc\/profile.d\/java.sh
> 
> \[root@localhost app\]\# java -version
> 
> java version "1.8.0\_101"
> 
> Java\(TM\) SE Runtime Environment \(build 1.8.0\_101-b13\)
> 
> Java HotSpot\(TM\) 64-Bit Server VM \(build 25.101-b13, mixed mode\)



